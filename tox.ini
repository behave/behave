# ============================================================================
# TOX CONFIGURATION: behave
# ============================================================================
# REQUIRES: pip install tox
# DESCRIPTION:
#   Use tox to run tasks (tests, ...) in a clean virtual environment.
#
# USAGE:
#   tox -e py39         #< Run tests with python3.9
#   tox -e py27         #< Run tests with python2.7
#
# SEE ALSO:
#   * https://tox.wiki/en/latest/config.html
# ============================================================================
# PIP_INDEX_URL = http://pypi.org/simple

[tox]
minversion   = 2.3
envlist      = py39, py27, py310, py38, pypy3, pypy, docs
skip_missing_interpreters = true


# -----------------------------------------------------------------------------
# TEST ENVIRONMENTS:
# -----------------------------------------------------------------------------
[testenv]
install_command = pip install -U {opts} {packages}
changedir = {toxinidir}
commands=
    pytest {posargs:tests}
    behave --format=progress {posargs:features}
    behave --format=progress {posargs:tools/test-features}
    behave --format=progress {posargs:issue.features}
deps= -r {toxinidir}/py.requirements/ci.tox.txt
setenv =
     PYTHONPATH = {toxinidir}


# -- HINT: Script(s) seems to be no longer installed on Python 2.7.
# WEIRD: pip-install seems to need "--user" option.
# RELATED: https://github.com/pypa/virtualenv/issues/2284 -- macOS 12 Monterey related
[testenv:py27]
# MAYBE: platform = darwin
install_command = pip install --user -U {opts} {packages}
changedir = {toxinidir}
commands=
    python -m pytest {posargs:tests}
    python -m behave --format=progress {posargs:features}
    python -m behave --format=progress {posargs:tools/test-features}
    python -m behave --format=progress {posargs:issue.features}
deps=
    {[testenv]deps}
setenv =
     PYTHONPATH = {toxinidir}


[testenv:docs]
changedir = docs
commands =
    sphinx-build -W -b html -D language=en -d {toxinidir}/build/docs/doctrees . {toxinidir}/build/docs/html/en
deps = -r{toxinidir}/py.requirements/docs.txt


[testenv:cleanroom2]
basepython = python2
changedir = {envdir}
commands=
    behave --version
    {toxinidir}/bin/toxcmd.py copytree ../../behave4cmd0 .
    {toxinidir}/bin/toxcmd.py copytree ../../tests .
    {toxinidir}/bin/toxcmd.py copytree ../../features .
    {toxinidir}/bin/toxcmd.py copytree ../../tools  .
    {toxinidir}/bin/toxcmd.py copytree ../../issue.features .
    {toxinidir}/bin/toxcmd.py copy ../../behave.ini .
    pytest {posargs:tests}
    behave --format=progress {posargs:features}
    behave --format=progress {posargs:tools/test-features}
    behave --format=progress {posargs:issue.features}
deps=
    {[testenv]deps}
setenv =
     PYTHONPATH = .:{envdir}


[testenv:cleanroom3]
basepython = python3
changedir = {envdir}
commands=
    behave --version
    {toxinidir}/bin/toxcmd.py copytree ../../behave4cmd0 .
    {toxinidir}/bin/toxcmd.py copytree ../../tests .
    {toxinidir}/bin/toxcmd.py copytree ../../features .
    {toxinidir}/bin/toxcmd.py copytree ../../tools  .
    {toxinidir}/bin/toxcmd.py copytree ../../issue.features .
    {toxinidir}/bin/toxcmd.py copy ../../behave.ini .
    {toxinidir}/bin/toxcmd.py 2to3 -w -n --no-diffs behave4cmd0
    {toxinidir}/bin/toxcmd.py 2to3 -w -n --no-diffs tools
    {toxinidir}/bin/toxcmd.py 2to3 -w -n --no-diffs features
    {toxinidir}/bin/toxcmd.py 2to3 -w -n --no-diffs issue.features
    pytest {posargs:tests}
    behave --format=progress {posargs:features}
    behave --format=progress {posargs:tools/test-features}
    behave --format=progress {posargs:issue.features}
deps=
    {[testenv]deps}
setenv =
     PYTHONPATH = .:{envdir}


# ---------------------------------------------------------------------------
# SELDOM-USED: OPTIONAL TEST ENVIRONMENTS:
# ---------------------------------------------------------------------------
# -- SELDOM-USED, TESTED-WITH: jython2.7
# JYTHON INSTALL RELATED (jit):
#   http://sikulix-2014.readthedocs.org/en/latest/scenarios.html
[testenv:jy27]
basepython= jython
commands=
    pytest {posargs:tests}
    behave --format=progress {posargs:features}
    behave --format=progress {posargs:tools/test-features}
    behave --format=progress {posargs:issue.features}
deps=
    jit
    {[testenv]deps}
